-- Pedidos com dados desnormalizados do comprador
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  buyer_name TEXT NOT NULL,
  buyer_email TEXT NOT NULL,
  buyer_phone TEXT,
  buyer_cep TEXT,
  buyer_rua TEXT,
  buyer_numero TEXT,
  buyer_bairro TEXT,
  buyer_cidade TEXT,
  total_amount NUMERIC(10,2) NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('pendente', 'completo')) DEFAULT 'pendente',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Itens do pedido com dados desnormalizados
CREATE TABLE order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  product_listing_id UUID NOT NULL REFERENCES product_listings(id),
  product_name TEXT NOT NULL,
  store_id UUID NOT NULL REFERENCES stores(id),
  store_name TEXT NOT NULL,
  price NUMERIC(10,2) NOT NULL,
  quantity INT NOT NULL CHECK (quantity > 0),
  subtotal NUMERIC(10,2) NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('pendente', 'entregue', 'cancelado')) DEFAULT 'pendente',
  status_updated_at TIMESTAMPTZ,
  status_updated_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_store_id ON order_items(store_id);
CREATE INDEX idx_order_items_status ON order_items(status);
CREATE INDEX idx_order_items_store_status ON order_items(store_id, status);
CREATE INDEX idx_order_items_status_updated_at ON order_items(status_updated_at);

-- RLS
CREATE POLICY orders_owner ON orders
  FOR ALL TO authenticated
  USING (auth_user_id() = user_id)
  WITH CHECK (auth_user_id() = user_id);

-- ============================================
-- ORDER ITEMS
-- ============================================

CREATE POLICY order_items_select ON order_items
  FOR SELECT TO authenticated
  USING (
    is_order_owner(order_id) OR 
    is_store_owner(store_id)
  );

CREATE POLICY order_items_insert ON order_items
  FOR INSERT TO authenticated
  WITH CHECK (is_order_owner(order_id));

CREATE POLICY order_items_update ON order_items
  FOR UPDATE TO authenticated
  USING (is_store_owner(store_id));
-- Trigger para updated_at
CREATE TRIGGER update_orders_updated_at 
  BEFORE UPDATE ON orders 
  FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();
