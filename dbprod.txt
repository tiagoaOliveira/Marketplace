-- Catálogo geral de produtos
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  category TEXT,
  subcategory TEXT,
  images TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Produtos específicos de cada loja
CREATE TABLE product_listings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id INT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  price NUMERIC(10,2) NOT NULL CHECK (price >= 0),
  stock INT NOT NULL DEFAULT 0 CHECK (stock >= 0),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Índices
CREATE INDEX idx_product_listings_product_id ON product_listings(product_id);
CREATE INDEX idx_product_listings_store_id ON product_listings(store_id);
CREATE INDEX idx_product_listings_active ON product_listings(is_active);

-- RLS

CREATE POLICY products_public ON products
  FOR SELECT USING (true);

CREATE POLICY products_insert ON products
  FOR INSERT TO authenticated
  WITH CHECK (auth_user_id() IS NOT NULL);
  
DROP POLICY IF EXISTS listings_select ON product_listings;

CREATE POLICY listings_select ON product_listings
  FOR SELECT
  USING (
    (
      (is_active = true AND EXISTS (
        SELECT 1 FROM stores
        WHERE id = store_id AND is_approved = true
      ))
      OR 
      is_store_owner(store_id)
    )
  );

CREATE POLICY listings_insert ON product_listings
  FOR INSERT TO authenticated
  WITH CHECK (is_store_owner(store_id));

CREATE POLICY listings_update ON product_listings
  FOR UPDATE TO authenticated
  USING (is_store_owner(store_id));

CREATE POLICY listings_delete ON product_listings
  FOR DELETE TO authenticated
  USING (is_store_owner(store_id));
